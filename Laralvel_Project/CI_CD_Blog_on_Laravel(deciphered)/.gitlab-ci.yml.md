```yaml
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç—Ç–∞–ø—ã (—Å—Ç–∞–¥–∏–∏) CI/CD –ø–∞–π–ø–ª–∞–π–Ω–∞
# –ü–∞–π–ø–ª–∞–π–Ω –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ: —Å–±–æ—Ä–∫–∞ ‚Üí —Ç–µ—Å—Ç ‚Üí –ø—Ä–æ–¥–∞–∫—à–Ω
stages:
  - build    # –≠—Ç–∞–ø —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞
  - deploy   # –≠—Ç–∞–ø –¥–µ–ø–ª–æ—è –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
  - prod     # –≠—Ç–∞–ø –¥–µ–ø–ª–æ—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ –≤—Å–µ—Ö –¥–∂–æ–±–∞—Ö
variables:
  # –ò–º—è Docker –æ–±—Ä–∞–∑–∞ —Å —Ç–µ–≥–æ–º –ø–æ SHA –∫–æ–º–º–∏—Ç–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–º–∏—Ç–∞)
  # $CI_REGISTRY_IMAGE - –∞–¥—Ä–µ—Å —Ä–µ–µ—Å—Ç—Ä–∞ –æ–±—Ä–∞–∑–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
  # $CI_COMMIT_SHA - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ö–µ—à —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  # –û–±—Ä–∞–∑ —Å —Ç–µ–≥–æ–º "latest" (–ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è)
  DOCKER_LATEST: $CI_REGISTRY_IMAGE:latest

# ========== building ... ==========
# –î–∂–æ–±–∞ –¥–ª—è —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞
build:
  # –£–∫–∞–∑—ã–≤–∞–µ–º, –∫ –∫–∞–∫–æ–º—É —ç—Ç–∞–ø—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —ç—Ç–∞ –¥–∂–æ–±–∞
  stage: build
  
  # –¢–µ–≥ —Ä–∞–Ω–Ω–µ—Ä–∞ GitLab, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å —ç—Ç—É –¥–∂–æ–±—É
  # –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–Ω–Ω–µ—Ä —Å —Ç–µ–≥–æ–º "ci"
  tags:
    - ci
    
  # Docker –æ–±—Ä–∞–∑ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ (—Å–∞–º–∞ —Å–±–æ—Ä–∫–∞ –∏–¥–µ—Ç –≤ Docker)
  image: docker:20.10.16
  
  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã - Docker-in-Docker –¥–ª—è —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
  services:
    - docker:20.10.16-dind
    
  # –ö–æ–º–∞–Ω–¥—ã, –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–µ –ø–µ—Ä–µ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º
  before_script:
    # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–≥–∏—Å—Ç—Ä–∏ –∏ –ø—Ä–æ–µ–∫—Ç–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    - echo "Registry URL:" $CI_REGISTRY
    - echo "Project:" $CI_REGISTRY_IMAGE
    - echo "Commit:" $CI_COMMIT_SHA
    # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker registry GitLab'–∞
    # $CI_REGISTRY_PASSWORD –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ stdin –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    
  # –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏
  script:
    - echo " ..... Building the Image .... $CI_COMMIT_REF_NAME ...."
    # –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑ –∏–∑ Dockerfile.prod —Å —Ç–µ–≥–æ–º –ø–æ –∫–æ–º–º–∏—Ç—É
    - docker build -f Dockerfile.prod -t $DOCKER_IMAGE .
    # –°–æ–∑–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–≥ "latest" –¥–ª—è —Ç–æ–≥–æ –∂–µ –æ–±—Ä–∞–∑–∞
    - docker tag $DOCKER_IMAGE $DOCKER_LATEST
    - echo "Sending to registry..."
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞–∑ —Å —Ç–µ–≥–æ–º –∫–æ–º–º–∏—Ç–∞ –≤ registry
    - docker push $DOCKER_IMAGE
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞–∑ —Å —Ç–µ–≥–æ–º "latest" –≤ registry
    - docker push $DOCKER_LATEST
    - echo "............. Building Complete! ....................."
    
  # –ò—Å–∫–ª—é—á–µ–Ω–∏—è: –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–±–æ—Ä–∫—É –¥–ª—è git —Ç–µ–≥–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–æ–∫)
  except:
    - tags

# ========== deploy on test (10.100.93.7) ==========
# –î–∂–æ–±–∞ –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
deploy:
  stage: deploy
  
  # –†–∞–Ω–Ω–µ—Ä —Å —Ç–µ–≥–æ–º "deploy2" (—Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä)
  tags:
    - deploy2
    
  script:
    - echo "Deploy on TEST server ..."
    # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–µ—Ä–µ –∏ –≤–µ—Ç–∫–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    - echo "Server:" $(hostname)
    - echo "Branch:" $CI_COMMIT_REF_NAME
    - echo "Downloading the image:" $DOCKER_IMAGE
    # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ registry –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ–±—Ä–∞–∑–∞
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    # –°–∫–∞—á–∏–≤–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑
    - docker pull $DOCKER_IMAGE
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (|| true = –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ—Ç)
    - docker stop laravel-blog-test || true
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    - docker rm laravel-blog-test || true
    # –°–æ–∑–¥–∞–µ–º volume –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
    - docker volume create laravel-test-db || true
    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
    # -d: –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
    # --name: –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    # --restart unless-stopped: –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
    # -p 8080:80: –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞ 8080 —Ö–æ—Å—Ç–∞ –Ω–∞ –ø–æ—Ä—Ç 80 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    # -v: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ volume –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    - docker run -d --name laravel-blog-test --restart unless-stopped -p 8080:80 -v laravel-test-db:/var/www/html/database $DOCKER_IMAGE
    # –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    - sleep 10
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
    - docker ps | grep laravel-blog-test
    - echo "Deploy on Test Env Done ! http://10.100.93.7:8080"
    
  # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: —ç—Ç–∞ –¥–∂–æ–±–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è build
  needs:
    - build
    
  # –£—Å–ª–æ–≤–∏–µ –∑–∞–ø—É—Å–∫–∞: —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–æ–∫, –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å "develop"
  # =~ –æ–∑–Ω–∞—á–∞–µ—Ç "—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é"
  only:
    variables:
      - $CI_COMMIT_REF_NAME =~ /^develop.*/

# ========== PRODUCTION (10.100.93.6) ==========
# –î–∂–æ–±–∞ –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä
prod:
  stage: prod
  
  # –†–∞–Ω–Ω–µ—Ä —Å —Ç–µ–≥–æ–º "deploy" (–ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä)
  tags:
    - deploy
    
  script:
    - echo "PRODUCTION DEPLOYMENT"
    - echo "Only from master branch"
    - echo "Server:" $(hostname)
    # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ registry
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    # –°–∫–∞—á–∏–≤–∞–µ–º –æ–±—Ä–∞–∑
    - docker pull $DOCKER_IMAGE
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–¥–∞–∫—à–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    - docker stop laravel-blog-prod || true
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    - docker rm laravel-blog-prod || true
    # –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π volume –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    - docker volume create laravel-prod-db || true
    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–¥–∞–∫—à–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–º—É, –Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ –∏–º–µ–Ω–∞–º–∏)
    - docker run -d --name laravel-blog-prod --restart unless-stopped -p 8080:80 -v laravel-prod-db:/var/www/html/database $DOCKER_IMAGE
    - sleep 10
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—Å–∫
    - docker ps | grep laravel-blog-prod
    - echo "PRODUCTION finished"
    - echo "http://10.100.93.6:8080"
    
  # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏
  needs:
    - build
    
  # –£—Å–ª–æ–≤–∏–µ: —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–∫–∏ master (—Ç–æ–ª—å–∫–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–¥ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–Ω)
  only:
    - master
```

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç CI/CD –ø–∞–π–ø–ª–∞–π–Ω –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ **–∫–æ–Ω–≤–µ–π–µ—Ä –Ω–∞ –∑–∞–≤–æ–¥–µ**, –≥–¥–µ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ –¥–µ–ª–∞—é—Ç –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç:

### üè≠ –≠—Ç–∞–ø 1: –°–±–æ—Ä–∫–∞ (build)
- **–ß—Ç–æ**: –ë–µ—Ä–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ "—É–ø–∞–∫–æ–≤—ã–≤–∞–µ–º" –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- **–ì–¥–µ**: –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–±–æ—Ä–∫–∏ 
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ì–æ—Ç–æ–≤—ã–π "–ø–∞–∫–µ—Ç" —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥ (registry)

### üß™ –≠—Ç–∞–ø 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (deploy)
- **–ß—Ç–æ**: –î–æ—Å—Ç–∞–µ–º "–ø–∞–∫–µ—Ç" —Å–æ —Å–∫–ª–∞–¥–∞ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
- **–ì–¥–µ**: –¢–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä (10.100.93.7:8080)
- **–ö–æ–≥–¥–∞**: –¢–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–æ–∫ `develop*` (–∫–æ–¥ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: QA –º–æ–∂–µ—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### üöÄ –≠—Ç–∞–ø 3: –ü—Ä–æ–¥–∞–∫—à–Ω (prod)  
- **–ß—Ç–æ**: –ë–µ—Ä–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π "–ø–∞–∫–µ—Ç" –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ì–¥–µ**: –ü—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä (10.100.93.6:8080)
- **–ö–æ–≥–¥–∞**: –¢–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–∫–∏ `master` (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–¥)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ

### üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:
- **–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø—É—à–∏—Ç –∫–æ–¥** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è ‚Üí —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è ‚Üí –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–ø–∞–¥–∞–µ—Ç –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ø—Ä–æ–¥–∞–∫—à–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–π –≤–µ—Ç–∫–∏ `master`
- **–û—Ç–∫–∞—Ç**: –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å, –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é

**–ò—Ç–æ–≥**: –û–¥–∏–Ω —Ñ–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –∫–æ–¥–∞ –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!


-----------------------------------------------------------------------------------------------------------
–ü—Ä–æ—Å—Ç–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—Å–µ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞
–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –ø–µ–∫–∞—Ä–Ω—é —Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º —Ö–ª–µ–±–∞:
üìã –ß—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å:

–†–µ—Ü–µ–ø—Ç —Ö–ª–µ–±–∞ = –í–∞—à –∫–æ–¥ Laravel –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3 –ø–µ—á–∏ = 3 —ç—Ç–∞–ø–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞ (build ‚Üí deploy ‚Üí prod)
2 –º–∞–≥–∞–∑–∏–Ω–∞ = –¢–µ—Å—Ç–æ–≤—ã–π –∏ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä—ã


ü•ñ –≠—Ç–∞–ø 1: –°–ë–û–†–ö–ê (build)
"–ì–æ—Ç–æ–≤–∏–º —Ç–µ—Å—Ç–æ –∏ –≤—ã–ø–µ–∫–∞–µ–º —Ö–ª–µ–±"
–ü–æ–≤–∞—Ä –±–µ—Ä–µ—Ç:
‚îú‚îÄ‚îÄ –ú—É–∫—É (–∫–æ–¥ Laravel) 
‚îú‚îÄ‚îÄ –í–æ–¥—É (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ nginx)
‚îú‚îÄ‚îÄ –î—Ä–æ–∂–∂–∏ (PHP –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
‚îî‚îÄ‚îÄ –°–ø–µ—Ü–∏–∏ (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Ñ–∞–π–ª—ã)

–ó–∞–º–µ—à–∏–≤–∞–µ—Ç —Ç–µ—Å—Ç–æ ‚Üí –≤—ã–ø–µ–∫–∞–µ—Ç ‚Üí –ø–æ–ª—É—á–∞–µ—Ç—Å—è –≥–æ—Ç–æ–≤—ã–π —Ö–ª–µ–± (Docker –æ–±—Ä–∞–∑)
–£–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥ (Docker registry)
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏:

–°–æ–±–∏—Ä–∞–µ—Ç—Å—è Docker –æ–±—Ä–∞–∑ –∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
–û–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ GitLab Container Registry
–°–æ–∑–¥–∞–µ—Ç—Å—è 2 –∫–æ–ø–∏–∏: —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –∏ "latest"


üß™ –≠—Ç–∞–ø 2: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï (deploy)
"–ü—Ä–æ–±—É–µ–º —Ö–ª–µ–± –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –º–∞–≥–∞–∑–∏–Ω–µ"
–ï—Å–ª–∏ —Ä–µ—Ü–µ–ø—Ç –∏–∑ –≤–µ—Ç–∫–∏ "develop":
‚îú‚îÄ‚îÄ –ë–µ—Ä–µ–º —Ö–ª–µ–± —Å–æ —Å–∫–ª–∞–¥–∞
‚îú‚îÄ‚îÄ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω (10.100.93.7:8080)
‚îú‚îÄ‚îÄ –í—ã—Å—Ç–∞–≤–ª—è–µ–º —Ö–ª–µ–± –Ω–∞ –ø–æ–ª–∫—É
‚îî‚îÄ‚îÄ QA-—Ç–µ—Å—Ç–µ—Ä—ã –ø—Ä–æ–±—É—é—Ç –∏ –¥–∞—é—Ç –æ—Ç–∑—ã–≤—ã
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏:

–°–∫–∞—á–∏–≤–∞–µ—Ç—Å—è Docker –æ–±—Ä–∞–∑ –∏–∑ registry
–°—Ç–∞—Ä—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏ —É–¥–∞–ª—è–µ—Ç—Å—è
–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 8080
–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö)


üè™ –≠—Ç–∞–ø 3: –ü–†–û–î–ê–ö–®–ù (prod)
"–ü—Ä–æ–¥–∞–µ–º —Ö–ª–µ–± –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–∞–≥–∞–∑–∏–Ω–µ"
–ï—Å–ª–∏ —Ä–µ—Ü–µ–ø—Ç –æ–¥–æ–±—Ä–µ–Ω –∏ –∏–∑ –≤–µ—Ç–∫–∏ "master":
‚îú‚îÄ‚îÄ –ë–µ—Ä–µ–º –ü–†–û–í–ï–†–ï–ù–ù–´–ô —Ö–ª–µ–± —Å–æ —Å–∫–ª–∞–¥–∞
‚îú‚îÄ‚îÄ –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞–≥–∞–∑–∏–Ω (10.100.93.6:8080)  
‚îú‚îÄ‚îÄ –í—ã—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
‚îî‚îÄ‚îÄ –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ –ø–æ–∫—É–ø–∞—é—Ç –∏ –µ–¥—è—Ç —Ö–ª–µ–±
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏:

–¢–æ–ª—å–∫–æ –∫–æ–¥ –∏–∑ –≤–µ—Ç–∫–∏ master –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–Ω
–ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –Ω–æ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ
–û—Ç–¥–µ–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω —Å—Ä–µ–¥—ã


üê≥ Docker-in-Docker (DinD) - –î–ï–¢–ê–õ–¨–ù–û
ü§î –ü—Ä–æ–±–ª–µ–º–∞:
–ß—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑, –Ω—É–∂–µ–Ω... Docker! –ù–æ GitLab Runner —Å–∞–º —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
–≠—Ç–æ –∫–∞–∫: –í–∞–º –Ω—É–∂–Ω–æ –∏—Å–ø–µ—á—å —Ö–ª–µ–±, –Ω–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ä–æ–±–∫–∏, –∞ –ø–µ—á—å —Å–Ω–∞—Ä—É–∂–∏.
üí° –†–µ—à–µ–Ω–∏–µ - Docker-in-Docker:
yamlimage: docker:20.10.16        # üì¶ –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å Docker –∫–ª–∏–µ–Ω—Ç–æ–º
services:
  - docker:20.10.16-dind      # üè≠ –û—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å Docker —Å–µ—Ä–≤–µ—Ä–æ–º
üèóÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   GitLab Runner (—Ö–æ—Å—Ç)      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ docker:20.10.16         ‚îÇ‚îÇ  ‚Üê –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å docker –∫–æ–º–∞–Ω–¥–∞–º–∏
‚îÇ  ‚îÇ                         ‚îÇ‚îÇ
‚îÇ  ‚îÇ docker build ...        ‚îÇ‚îÇ  ‚Üê –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã —Å–±–æ—Ä–∫–∏
‚îÇ  ‚îÇ docker push ...         ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ              ‚Üï —Å–µ—Ç—å          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ  
‚îÇ  ‚îÇ docker:20.10.16-dind    ‚îÇ‚îÇ  ‚Üê –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å Docker –¥–µ–º–æ–Ω–æ–º
‚îÇ  ‚îÇ                         ‚îÇ‚îÇ
‚îÇ  ‚îÇ [Docker Engine]         ‚îÇ‚îÇ  ‚Üê –ó–¥–µ—Å—å —Ä–µ–∞–ª—å–Ω–æ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –æ–±—Ä–∞–∑—ã
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
üîß –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∞–ª–æ–≥–∏—è:
–ë–µ–∑ DinD:
–ü–æ–≤–∞—Ä —Å–∏–¥–∏—Ç –≤ –∫–æ—Ä–æ–±–∫–µ –∏ –∫—Ä–∏—á–∏—Ç: "–ò—Å–ø–µ–∫–∏ —Ö–ª–µ–±!"
–ù–æ –ø–µ—á–∏ –Ω–µ—Ç ‚Üí –æ—à–∏–±–∫–∞
–° DinD:
–ü–æ–≤–∞—Ä –≤ –æ–¥–Ω–æ–π –∫–æ—Ä–æ–±–∫–µ –≥–æ–≤–æ—Ä–∏—Ç: "–ò—Å–ø–µ–∫–∏ —Ö–ª–µ–±!"
–í —Å–æ—Å–µ–¥–Ω–µ–π –∫–æ—Ä–æ–±–∫–µ —Å—Ç–æ–∏—Ç –ø–µ—á—å ‚Üí —Ö–ª–µ–± –≤—ã–ø–µ–∫–∞–µ—Ç—Å—è ‚úÖ
üìã –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—à–∞–≥–æ–≤–æ:

GitLab –∑–∞–ø—É—Å–∫–∞–µ—Ç job –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ docker:20.10.16
–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–µ—Ä–≤–∏—Å docker:20.10.16-dind
Docker –∫–ª–∏–µ–Ω—Ç (–≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ) –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Docker –¥–µ–º–æ–Ω—É (–≤ —Å–µ—Ä–≤–∏—Å–µ)
–ö–æ–º–∞–Ω–¥—ã docker build –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ –Ω–∞ Docker –¥–µ–º–æ–Ω–µ
–ì–æ—Ç–æ–≤—ã–π –æ–±—Ä–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ registry


üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ –≤—Å–µ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞:
–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø—É—à–∏—Ç –∫–æ–¥
           ‚Üì
    üè≠ –°–ë–û–†–ö–ê (build)
    ‚îú‚îÄ‚îÄ –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑ (DinD)
    ‚îî‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ registry
           ‚Üì
    üß™ –¢–ï–°–¢ (deploy) [–µ—Å–ª–∏ –≤–µ—Ç–∫–∞ develop*]
    ‚îú‚îÄ‚îÄ –°–∫–∞—á–∏–≤–∞–µ–º –æ–±—Ä–∞–∑
    ‚îú‚îÄ‚îÄ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    ‚îî‚îÄ‚îÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –Ω–∞ :8080
           ‚Üì
    üöÄ –ü–†–û–î–ê–ö–®–ù (prod) [–µ—Å–ª–∏ –≤–µ—Ç–∫–∞ master]
    ‚îú‚îÄ‚îÄ –°–∫–∞—á–∏–≤–∞–µ–º –æ–±—Ä–∞–∑  
    ‚îú‚îÄ‚îÄ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    ‚îî‚îÄ‚îÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –Ω–∞ :8080
           ‚Üì
    üòä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
–í—Å—è –º–∞–≥–∏—è –≤ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò! –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å—Ç–æ –ø—É—à–∏—Ç –∫–æ–¥, –∞ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.