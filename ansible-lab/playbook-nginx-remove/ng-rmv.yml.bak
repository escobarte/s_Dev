---
- name: Полное удаление Nginx и всех остатков
  hosts: all
  become: yes

  tasks:
    - name: Остановить сервис nginx (игнорировать ошибки)
      ansible.builtin.service:
        name: nginx
        state: stopped
      ignore_errors: yes

    - name: Отключить сервис nginx (игнорировать ошибки)
      ansible.builtin.service:
        name: nginx
        enabled: no
      ignore_errors: yes

    - name: Удалить пакеты nginx
      ansible.builtin.apt:
        name:
          - nginx
          - nginx-common
          - nginx-full
        state: absent
        purge: yes
        update_cache: yes

    - name: Удалить неиспользуемые зависимости
      ansible.builtin.apt:
        autoremove: yes

    - name: Удалить основные каталоги nginx
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/nginx
        - /var/log/nginx
        - /var/cache/nginx
        - /usr/lib/nginx
        - /usr/share/nginx
        - /var/www/html
        - /usr/local/src/ModSecurity-nginx/.github/nginx

    - name: Очистить apt-кэш
      ansible.builtin.command: apt clean

    - name: Убить оставшиеся процессы nginx (если остались)
      ansible.builtin.shell: pkill -f nginx || true

    - name: Найти остаточные файлы nginx (только выводит, не удаляет)
      ansible.builtin.shell: "find / -name '*nginx*' | grep -v 'filebeat/module/nginx' || true"
      register: nginx_leftovers

    - name: Вывести список найденных остатков
      ansible.builtin.debug:
        var: nginx_leftovers.stdout_lines
