#  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Keepalived + Nginx —Å Unicast –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

---

##  –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ 'nginx'

–°–æ–∑–¥–∞—ë–º bash-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Ü–µ—Å—Å–∞ nginx:

```bash
#!/bin/sh                        # –ò—Å–ø–æ–ª—å–∑—É–µ–º shell-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä
if [ -z "`pidof nginx`" ]; then  # –ï—Å–ª–∏ nginx –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
  exit 1                         # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–∫—Ä–∏–ø—Ç —Å –æ—à–∏–±–∫–æ–π
fi                               # –ò–Ω–∞—á–µ - nginx —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
```

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:

```bash
sudo chmod 755 /bin/check_nginx.sh  # –î–∞—ë–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
```

---
## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `/etc/keepalived/keepalived.conf`

###  –ë–ª–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ nginx

```conf
vrrp_script check_nginx {
  script "/bin/check_nginx.sh"  # –ü—É—Ç—å –¥–æ —Å–∫—Ä–∏–ø—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç nginx
  interval 2                    # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  weight 50                     # –í–µ—Å, –ø—Ä–∏–±–∞–≤–ª—è–µ–º—ã–π –∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ
}
```

---

## Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VRRP-–∏–Ω—Å—Ç–∞–Ω—Å–∞

###  MASTER-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Å–µ—Ä–≤–µ—Ä: `10.100.93.3`)

```conf
vrrp_instance VI_1 {
    state MASTER                     # –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Å—Ç–∞–Ω—Å–∞ ‚Äî MASTER
    interface ens192                 #  –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç VIP (–ø—Ä–æ–≤–µ—Ä—å —á–µ—Ä–µ–∑ `ip a`)
    virtual_router_id 51            # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–∞
    priority 100                    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ MASTER (–±–æ–ª—å—à–µ ‚Äî –≤—ã—à–µ —à–∞–Ω—Å —Å—Ç–∞—Ç—å MASTER)
    advert_int 1                    # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π (—Å–µ–∫)

    authentication {
        auth_type PASS              # –¢–∏–ø –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ‚Äî –ø–æ –ø–∞—Ä–æ–ª—é
        auth_pass 123456            #  –ü–∞—Ä–æ–ª—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏
    }

    virtual_ipaddress {
        10.100.93.2                 #  –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IP-–∞–¥—Ä–µ—Å (VIP)
    }

    track_script {
        check_nginx                 # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è nginx
    }

    unicast_src_ip 10.100.93.3      #  –ù–∞—à –∏—Å—Ö–æ–¥—è—â–∏–π IP –¥–ª—è unicast
    unicast_peer {
        10.100.93.4                 #  IP –≤—Ç–æ—Ä–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (SLAVE)
    }
}
```

---

###  BACKUP-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Å–µ—Ä–≤–µ—Ä: `10.100.93.4`)

```conf
vrrp_instance VI_1 {
    state BACKUP                    # –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî BACKUP
    interface ens192
    virtual_router_id 51
    priority 90                     # –ù–∏–∂–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —á–µ–º —É MASTER

    advert_int 1

    authentication {
        auth_type PASS
        auth_pass 123456
    }

    virtual_ipaddress {
        10.100.93.2
    }

    track_script {
        check_nginx
    }

    unicast_src_ip 10.100.93.4      #  –ù–∞—à –∏—Å—Ö–æ–¥—è—â–∏–π IP (SLAVE)
    unicast_peer {
        10.100.93.3                 #  IP MASTER-—Å–µ—Ä–≤–µ—Ä–∞
    }
}
```

---

##  –§–∏–Ω–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```bash
sudo systemctl restart keepalived  # üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–±—É Keepalived
```

 –í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ **–æ–±–æ–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö** –ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

‚úÖ –¢–µ–ø–µ—Ä—å Keepalived –±—É–¥–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å nginx –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å unicast –¥–ª—è –æ–±–º–µ–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞–º–∏ –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏.