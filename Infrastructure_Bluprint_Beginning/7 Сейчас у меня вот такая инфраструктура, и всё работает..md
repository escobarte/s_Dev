# Финальный этап настройки инфраструктуры

---

## ЗАДАЧА 1: Установить HTTPS на VIP (93.2)

### Self-signed сертификат (если тестовая среда)

Настройка `nginx` на `Prx01/Prx02` для прослушивания порта 443:

```nginx
server {
    listen 443 ssl;
    server_name app.lab.local;

    ssl_certificate     /etc/nginx/ssl/app.crt;
    ssl_certificate_key /etc/nginx/ssl/app.key;

    location / {
        proxy_pass http://app_backend;
        ...
    }
}
```

Если нужен Let's Encrypt с автоматизацией — можно использовать `certbot`.

---

## ЗАДАЧА 2: Ограничить трафик на Proxy (Prx01, Prx02), оставить только 80 и 443

Настройка IPTables:

```bash
# Установить политику по умолчанию
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT

# Разрешить локальные соединения
sudo iptables -A INPUT -i lo -j ACCEPT

# Разрешить порты 80 и 443 (HTTP и HTTPS)
sudo iptables -A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT

# Разрешить ICMP (ping)
sudo iptables -A INPUT -p icmp -j ACCEPT

# Разрешить установленные соединения
sudo iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# Временно разрешить SSH от SAS-подразделения
sudo iptables -A INPUT -p tcp --dport 22 -s <SAS-IP-Range> -j ACCEPT

# Сохранить правила
sudo iptables-save > /etc/iptables/rules.v4
```

---

## ЗАДАЧА 3: SSH только для SAS Department

Нужно уточнение:

- Как идентифицируется SAS: по IP-подсети? Active Directory? LDAP?
- Если это IP-подсеть, пример:

```bash
sudo iptables -A INPUT -p tcp --dport 22 -s 172.29.10.0/24 -j ACCEPT
```

---

## ЗАДАЧА 4: Оптимизация Ubuntu VM

### Системные настройки:

```bash
# Снижаем использование свопа
echo "vm.swappiness=10" | sudo tee /etc/sysctl.d/99-swappiness.conf
```

### Лимиты открытых файлов:

```bash
echo "* soft nofile 65535" | sudo tee -a /etc/security/limits.conf
echo "* hard nofile 65535" | sudo tee -a /etc/security/limits.conf
```

### systemd настройки:

```bash
# Уменьшение таймаутов запуска
sudo nano /etc/systemd/system.conf
# Изменить или добавить:
DefaultTimeoutStartSec=10s
```

### Отключение ненужных сервисов:

```bash
sudo systemctl disable --now snapd
sudo systemctl disable --now apt-daily.timer
sudo systemctl disable --now cloud-init
```

### Тюнинг Nginx:

```nginx
worker_processes auto;
worker_connections 4096;
keepalive_timeout 15;
```

---

Готово. При необходимости могу разложить каждый пункт по шагам с командами.
