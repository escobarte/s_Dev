deploy:
    stage: deploy
    before_script:
        # Initialization the SSH connection
        - *init_ssh
    script:
        # Deployment steps:
        # 1. Create the target folder if does not exist
        # 2. Change directory to target folder
        # 3. Clone repository if git is not setup yet
        # 4. Checkout to desired branch
        # 5. Pull the updates for specific branch
        # 6. Install the dependencies
        # 7. Run the migration
        - ssh $SSH_USER@$SSH_HOST "mkdir -p $DEPLOY_PATH && cd $DEPLOY_PATH && [[ -d .git ]] || git clone git@gitlab.com:$CI_PROJECT_PATH.git ./ && git checkout master && git pull origin master && composer install --no-dev --optimize-autoloader && yarn install --prod && yarn prod && php artisan migrate --force"
    environment:
        name: production
    only:
        - master